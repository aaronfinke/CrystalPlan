
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<title></title>
<meta name="generator" content="Bluefish 1.0.7"/>
<meta name="author" content="Janik Zikovsky"/>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
<meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8"/>
<meta http-equiv="content-style-type" content="text/css" />
</head>

<style type="text/css">
	.break { page-break-before: always; }

img {
	vertical-align:middle;
	}
IMG.frameshot 
	{
	display: block;
	margin-left: auto;
   margin-right: auto;
   padding-top: 15px;
   padding-bottom: 15px;
   }
IMG.centered 
	{
	display: block;
	margin-left: auto;
   margin-right: auto;
   padding-top: 15px;
   padding-bottom: 15px;
   }
dt {
	display: list-item;
	font-weight:bold;
	padding-bottom: 3px;
	}
h1 {
	font-size:28pt;
	padding-left:10px;
	}
h2 {
	font-size:24pt;
	border-top:medium solid #000000;
	}
h3 {
	font-size:20pt;
	border-top:thin solid #000000;
	padding-top:5px;
	}
h4 {
	font-size:16pt;
	border-top:thin dashed #000000;
	padding-top:5px;
	}
li {
	padding-top:3px;
	}
ul {
	padding-bottom: 5px;
	}
hr {
border: 0;
color: #9E9E9E;
background-color: #9E9E9E;
height: 1px;
width: 100%;
text-align: left;
}
</style>



<script 
  type="text/JavaScript" 
  language="JavaScript">
 <!-- 
// format date as dd-mmm-yy; example: 12-Jan-99
function date_ddmmmyy(date)
{
  var d = date.getDate();
  var m = date.getMonth() + 1;
  var y = date.getYear();

  // handle different year values returned by IE and NS in the year 2000.
  if(y >= 1900)
  {    y -= 1900;   }
  y += 1900;

  // could use splitString() here 
  // but the following method is 
  // more compatible
  var mmm = 
    ( 1==m)?'January':( 2==m)?'February':(3==m)?'March':
    ( 4==m)?'April':( 5==m)?'May':(6==m)?'June':
    ( 7==m)?'July':( 8==m)?'August':(9==m)?'September':
    (10==m)?'October':(11==m)?'November':'December';

  return "" + mmm + " " + (d<10?"0"+d:d) + ", " + y;
}


// get last modified date of the 
// current document.
function date_lastmodified()
{
  var lmd = document.lastModified;
  var s   = "Unknown";
  var d1;

  // check if we have a valid date
  // before proceeding
  if(0 != (d1=Date.parse(lmd)))
  {
    s = "" + date_ddmmmyy(new Date(d1));
  }

  return s;
}

//
// finally display the last modified date
// as DD-MMM-YY
//
-->
</script>





<body bgcolor="white">

<img src="../gui/icons/CrystalPlan_icon.png" width="256" height="256" border="0" alt="CrystalPlan Icon" align="right" />

<h1>CrystalPlan 1.0 User Guide</h1>
by Janik Zikovsky (zikovskyjl@ornl.gov)<br/>
<br/>
Document started April 14, 2010; 
<script type="text/JavaScript" language="JavaScript">
document.write( "last updated on " + date_lastmodified() + "." );
</script>
<br/>
  
<h2>Introduction</h2>

<p>CrystalPlan is an experiment planning tool for crystallography; CrystalPlan...
</p>
<ul>
<li>Lets you put in a list of sample orientation angles, and...</li>
<li>...calculates the coverage of detectors in reciprocal space.</li>
<li>When you give it your sample's lattice parameters and UB matrix, it...</li>
<li>...predicts the positions of single-crystal peaks.</li>
<li>You can then optimize your experiment by trying different orientations and seeing if your coverage statistics will still be adequate.</li>
</ul>

<!-- ========================================================= -->
<!-- ========================================================= -->
<!-- ========================================================= -->

<h2>Step-by-Step Tutorial</h2>

<p>This tutorial will show you how to use most of the features of CrystalPlan by going through a typical run, step-by-step.</p>


<!-- ========================================================= -->

<h3>1. Starting CrystalPlan</h3>

<p>From the terminal command line, type:
<div align="center"><font face="Courier">crystalplan.py</font></div>
The GUI launches in two new windows. Select the main window:
</p>
<br/>
<img class="frameshot" src="screenshots/frame_main.png" width="400" border="0" alt="The main CrystalPlan GUI window."/><br/>
<br/>
Most of your workflow will occur by navigating between these notebook tabs:
<br/><img src="animations/frame_main-tab_anim.png" border="0"/>

<!-- ========================================================= -->

<h3>2. Defining the Reciprocal Space of Interest and Wavelengths</h3>

<p>Here you will set the general parameters of your experiment.</p>

<ul>
<li>Click the "Q-Space" tab, if it not already selected. If necessary, change the parameters so that it matches those shown below:
<br/><img src="screenshots/startup-traits.png" border="0" alt=""/>
</li>
<ul>
	<dt>d_min</dt>
	<dd>The smallest d-spacing allowed. Your simulated q-space will be limited to a maximum <span class="eq">$q = {2\pi}/d_{min}$</span></dd>
	
	<dt>q-resolution</dt>
	<dd>The size of a voxel (smallest volume element) simulated, in <span class="eq">$\AA^{-1}$</span>. The # of points will be calculated and shown below; you will get a warning if you try to make very high-resolution calculations, because memory consumption, etc. will be very high.</dd>
	
	<dt>wavelength limits</dt>
	<dd>Specify your experiment's wavelength limits, in Ansgtroms; this could be due to limits on your neutron source or your detectors.</dd>
</ul>

<li>When done, click the 
<img src="screenshots/startup-apply.png" border="0" alt="Apply Changes"/>
button. Changing these settings requires re-doing a lot of calculations, which may take some time if you have a lot of orientations saved. 
</li>
</ul>


<!-- ========================================================= -->

<h3>3. Detectors</h3>

Here, you ensure that CrystalPlan has the correct detector geometry loaded.

<ul>
<li>Click the "Detectors" tab.</li>

<li>Load a detector geometry by clicking the
<img src="screenshots/detectors-buttonLoadDetectors.png" border="0" alt=""/> button. In the File Loading dialog that opens, select the "TOPAZ_detectors_all.csv" file.
</li>
<li>After a few seconds, the detector geometry is loaded. To confirm that the detectors are in the correct positions, you can visualize them in direct space by clicking 
<img src="screenshots/detectors-button_view_detectors.png" border="0" alt=""/>, 
which displays them in a window like this one:
<br/><img class="frameshot" src="screenshots/detectors-3d_view.png" border="0" alt=""/>
</li>
<li>We will come back later to the other controls on this tab.</li>
</ul>


<!-- ========================================================= -->

<h3>4. Goniometer</h3>


Now, you want to make sure that CrystalPlan is aware of which goniometer is currently in
use in your instrument.

<ul>
<li>Click the "Goniometer" tab. The goniometer that is currently selected is shown at the top:
<img src="screenshots/goniometer-selected.png" border="0" alt=""/>
</li>
<li> Select the TOPAZ in-house goniometer:
<br/><img src="screenshots/goniometer-choice.png" border="0" alt=""/>
</li>
<li>Some general information about the goniometer is shown:
<br/><img src="screenshots/goniometer-desc.png" border="0" alt=""/>
</li>
<li>But your selection is not complete until you click 
<img src="screenshots/goniometer-buttonSwitchGoniometer.png" border="0" alt=""/>
</li>
<li>The program will now be aware of the sample orientation angle limitations that your instrument has, and will give you warnings if you try to use an inaccessible sample orientation.</li>
</ul>

<!-- ========================================================= -->

<h3>5. Sample Settings</h3>

Now, you will want to enter or load in information about your sample: crystal lattice parameters, UB matrix, etc.

<ul>
<li>Click the "Sample" tab. You are presented with an overview of the crystal parameters
<br/><img src="screenshots/sample-info.png" border="0" alt=""/>
</li>

<h4>5.1. Edit Crystal Parameters dialog</h4>

<li>Click
<img src="screenshots/sample-buttonEditCrystal.png" border="0" alt=""/>. 
</li>
<ul>
<li>This brings up the "Edit Crystal Parameters" dialog box. You may edit the name and description:
<br/><img class="frameshot" src="screenshots/dialog_edit_crystal.png" border="0" alt=""/></li>
<li>The top of the dialog shows you the current crystal parameters.</li>
<br/>
<li>The <a href="screenshots/dialog_edit_crystal-notebook1.png">"Manually Enter Lattice" tab</a>
allows you to try out the program by typing in
your lattice parameters and the sample mounting. 
Clicking the 
<img src="screenshots/dialog_edit_crystal-buttonGenerateUB.png" border="0" alt=""/> button would create a UB matrix that you can use to test features of the program; however we will not be doing that in this tutorial.
</li>



<br/>
<li>Instead, go to the "Load from ISAW" tab:
<br/><img src="screenshots/dialog_edit_crystal-notebook0.png" border="0" alt=""/> 
</li>
<li>If this were a real experiment, at this point you would have had acquired an adequate set of data at a starting sample orienation, and saved the run.</li>
<li>You would then load that data into ISAW in order to find the sample orientation.</li>
<li>ISAW can generate a UB matrix file that contains:</li>
<ul> 
<li>The crystal's <i>measured</i> UB matrix - this contains information about how the crystal is mounted relative to </li>
<li>The crystal's lattice lengths and angles. </li>
</ul>
<li>To learn how to calculate a UB matrix, please refer to ISAW's documentation. Using ISAW, you will be using the Initial Peaks wizard to locate and index the peaks. This method can be used to find both the lattice parameters and UB matrix, or you can specify the lattice parameters if known.</li>
<li>You can also generate the same file using ISAWev (the ISAW event viewer), working directly from event data in reciprocal space. The procedure is the same (find and index the peaks) though the interface is a little different. Both methods generate exactly the same file format.</li>
<li><font size="+1">However, the UB matrix output by ISAW <b>includes the orientation due to the goniometer</b> and not just the crystal mounting orientation.</font>
</li>
<ul>
<li>The UB matrix needs to be corrected to account for this extra rotation.</li>
<li>This requires you to enter the goniometer angles corresponding to the sample orientation in the UB matrix file to load - the goniometer settings at the time that data was acquired.
</li>
<li>Enter these angles, in degrees, here:
<img src="screenshots/dialog_edit_crystal-control_load_angles.png"/>
</li>
</ul>
<li>A sample UB matrix file can be found in the "model/data/quartzub.txt" file. Click the 
<img src="screenshots/dialog_edit_crystal-buttonReadUB.png"/>
button and select this file in the dialog.
</li>
<li>The top of the dialog shows you the loaded lattice parameters and UB matrix.
<br/><img src="screenshots/dialog_edit_crystal-control_top.png"/>
</li>
<li>From here, you can set the crystal's point group symmetry; however, we will leave it as "-1 (Triclinic)", as shown.</li>
<li>Click
<img src="screenshots/dialog_edit_crystal-buttonOK.png"/> 
to apply the changes; clicking 
<img src="screenshots/dialog_edit_crystal-buttonCancel.png"/>
would revert all the changed made in the dialog. 
</li>
<li>Some recalculations will occur when changing the crystal lattice parameters or orientation.</li>
</ul>

<h4>5.2. Choosing H,K,L ranges</h4>

<li>Still in the Sample tab, the following GUI allows you to pick which HKL to display:
<br/><img src="screenshots/sample-range_control.png"/>
</li>
<li>These H,K,L ranges limit which peak indices that CrystalPlan will calculate and display.
</li>
<li>You can type in your ranges manually, however, I recommend that you keep both checkboxes checked:</li>
<ul>
<li>They use the <i>d_min</i> parameter you set earlier in the "Q-Space" tab. </li>
<li>The first checkbox tells CrystalPlan to calculate the H,K,L ranges that fill a box of side in q-space corresponding to 
<span class="eq">$d_{min}$</span>. </li>
<ul>
<li>But, the resulting peaks will form a cube only if all the lattice angles are 90 degrees.</li>
</ul>
<li>By checking the second box, any peaks with a d-spacing smaller that <i>d_min</i> will be rejected, leaving a sphere of reflections in q-space.</li>
</ul>
<li>Click the <img src="screenshots/sample-buttonApplyRange.png"/> button to apply 
any changes you have made. All reflections are re-calculated.
</li>
<li>Be aware that for large cells, the number of reflections within a given 
<span class="eq">$d_{min}$</span>
 may be very large, slowing down calculations and requiring a lot of memory.</li>


</ul>
<!-- ========================================================= -->

<h3>6. Trying Sample Orientations</h3>

<p>At this point, we have given the program all the information it needs to start predicting what we can measure. We will now tell it what sample orientations we will try.
</p>

<ul>
<li>Click on the "Try an Orientation" tab. 
<br/><img src="screenshots/try.png" border="0" alt=""/>
</li>
<li>Check the <img src="screenshots/try-checkAdd.png"/> box.
</li>
<li>Now, you simulate a sample orientation.</li>
<ul>
<li>As you change the values, the coverage calculation is re-done and updated in the 3D viewer (which we will look at next). </li>
<li>Use the slider or type in (and press Enter) to set a Phi angle of 30 degrees, while keeping the other two angles at 0 degrees.
<br/><img src="screenshots/try-phi-30.png"/>
</li>
</ul>
</ul>


<!-- ========================================================= -->

<h3>7. The Reciprocal Space 3D Viewer</h3>

<p>Congratulations on making it this far! We will now look at the result of 
our simulated detector coverage.</p>

<ul>
<li>Switch window to the Reciprocal Space 3D Viewer (this window opens with CrystalPlan, so it should already be open - otherwise, you can open it from the "View" menu).
<img class="frameshot" src="screenshots/frame_qspace.png"  />
</li>

<li>The main part of the window is a 3D view of reciprocal space.</li>
<ul>
<li>The white cube outline represents the extent of q-space that is simulated.</li>
<li>The center of the cube is q = [0,0,0], which corresponds of course to h,k,l = [0,0,0]</li>
<li>The cube is sized so as to <i>just</i> hold a sphere of radius 
<span class="eq">$q = \frac{2\pi}{d_{min}}$</span>
</li>
</ul>
 <li>Right now, we are in "volume coverage" mode, which means that the shapes shown in cyan correspond to the <i>volume</i> in reciprocal space that has been measured by a detector.  
</li>
<ul>
<li>When a "voxel" (volume pixel) has been measured once, it is marked as a value of "1".</li>
<li>The surface you see is the isosurface (the edge between 0 measurements and 1 measurement).</li>
<li>The "sharpness" of this 3D view is determined by the q-resolution you specified in the "Q-Space" tab at the beginning. You can change this resolution at any time, and the coverage will be recalculated at this new resolution.</li>
</ul>


<li>You can interact with the 3D view in a number of ways:</li>
<ul>
<li>Click the left mouse button and drag to rotate the view around the center.</li>
<li>Hold SHIFT (or use the middle mouse button) to pan the scene around.</li>
<li>Hold CTRL to rotate the scene only around the camera's axis (roll).</li>
<li>Hold SHIFT+CTRL (or use the right mouse button) to zoom in and out by moving the mouse.</li>
<li>Use the mouse wheel to zoom in and out.</li>
<li>Press = and - to zoom in and out.</li>
<li>Press R to reset the zoom level and center the camera.</li>
<li>Press 3 to enable two-colour 3D rendering (with cyan/blue glasses you could see it in "real" 3D <i>a la</i> a 1950's B-movie :-) )</li>
</ul>
<li>The buttons at the top of the view, from left to right, are:</li>
<ul>
<li>6 buttons to reset the views quickly, facing the given directions.</li>
<li>Default isometric view.</li>
<li>Turn on orthographic projection (no perspective effects - this is very handy when looking a ordered peaks).</li>
<li>Display the 3D axes.</li>
<li>Go fullscreen (press Esc to go back)</li>
<li>Save a screenshot.</li>
</ul>

<li>We will return to this window to explain the elements in more detail.</li>
<li>For now, you can change the Phi angle in the "Try An Orientation" tab and visualize how that 
affects the reciprocal space coverage in this window. This animation shows the effect of changing the phi of the sample from -180 to +180 degrees:
<br/><img class="centered" src="animations/3d-phi_rotation_anim.png" border="0"/>
</li>
<li>And this animation shows a chi (tilt) rotation from -180 to +180 degrees, with phi kept constant:
<br/><img class="centered" src="animations/3d-chi_rotation_anim.png" border="0"/>
</li>

</ul>


<!-- ========================================================= -->

<h3>9. Goniometer Limits</h3>

<ul>
<li>Back in the Main Window's "Try Position" tab, try to set a Chi angle of +45 degrees:
<br/><img src="screenshots/try-chi-45.png"/>
</li>

<li>... and you will see the following warning message: 
<br/><img src="screenshots/try-staticTextWarning.png" />
<br/>informing you that you have tried a sample orientation that is not achievable by 
the selected goniometer.
</li>
<ul>
<li>Not all goniometers have such limitations; for instance, if you select the "Simple Goniometer", there are no limits to the angles you can reach.</li>
<li>However, the currently selected "TOPAZ In-House Goniometer" is limited in Chi tilt because of its design (a 3-legged "tripod" design). It can only tilt by a few degrees above or below zero.</li>
<li>CrystalPlan calculated which angles are possible and warns you if they are not. A string describing the <i>reason</i> why this angle is not possible is displayed, if available. </li>
</ul>
<li>You can still simulate this sample orientation, but be aware that you will not be able to achieve it experimentally.</li>
</ul>



<!-- ========================================================= -->

<h3>10. Adding Several Sample Orientations</h3>


<p>Now, we will start building up an experiment plan by adding sample orientations.</p>

<ul>
<li>First, uncheck the <img src="screenshots/try-checkAdd.png"/> box; this will remove the "trial" position from the coverage calculation.
</li>
<li>Switch to the "Add Orientations" tab.</li>

<h4>10.1. Entering Lists of Angles</h4>

<li>Near the top of the window, you will see 3 text boxes where you can enter lists of angles to simulate:
<br/><img src="screenshots/add-lists.png" />
</li>
<li>You can enter lists in 3 ways, based on Python script:</li>
<ul>
<li>A simple list separated by commas: "<strong>10, 22.5, -180</strong>". You do not need to include square brackets.</li>
<li>An evenly divided linear range: "<strong>linspace(start, stop, steps)</strong>" will give you <i>steps</i> points, evenly divided from <i>start</i> to <i>stop</i> (inclusive).</li>
<li>A range of values in fixed steps: "<strong>arange(start, stop, step_size)</strong>" will step starting at <i>start</i>, go up in steps of <i>step_size</i>, until you reach <i>stop</i> - but does <u>not</u> include <i>stop</i>.</li>
</ul>
<li>Angles are stepped through for each list: for example, if you put lists containing 5 phi angles, 4 chi angles, and 2 omega angles, your resulting list of sample orientations will have 40 phi, chi, omega combinations.</li>


<h4>10.2. Checking Validity of Orientations</h4>

<li>Enter the following values in the angle lists: 
<br/><img src="screenshots/add-lists2.png" />
</li>
<ul>
<li>You should see the following text below the angles:
<br/><img src="screenshots/add-textWarnings.png" />
</li>
<ul><li>This box tells you that some of the angles you supplied were not achievable with the goniometer, and why. These angles will not be calculated.</li>
<li>The remaining sample orientations will be calculated.</li>
</ul>
</ul>


<h4>10.3. Adding Sample Orientations To Plan</h4>

<li>Enter the following values in the angle lists: 
<br/><img src="screenshots/add-lists3.png" />
<br/>All of these sample orientations are possible.
</li>
<ul>
<li>
When you have entered your lists of angles, click the "Start" button to begin the calculation. 
<br/><img src="screenshots/add_positions-start_button.png" />
</li>

<li>The program now calculates the coverage at each sample orientation, and saves it in the
experiment plan (which we will see in the next section).</li>

<li>The calculation progress will be shown in this progress bar: <br/>
<img src="screenshots/add_positions-progress_bar.png" border="0" alt=""/> <br/></li>

<li>If the calculation runs too long, you can cancel it before it completes. Sample orientations that have already been calculated will remain in the experiment plan.<br/>
<img src="screenshots/add_positions-cancel_button.png" border="0" alt=""/></li>
</ul>

<br/>
<li>Another way to add sample orientations is to click the
 <br/><img src="screenshots/try-buttonSave.png" /> button,
 <br/>  in the "Try an Orientation" tab. This adds to the experiment plan whatever sample orientation angles you tried by setting those sliders. 
</li>
</ul>

<!-- ========================================================= -->

<h3>11. The Experiment Plan</h3>

<li>Switch to the "Experiment Plan" tab. Here, you see a grid with a list of all the sample orientations that have been calculated up to now:
<br/><img src="screenshots/exp-grid.png" /> 
</li>
<ul>
<li>Each row lists the sample orientation angles you will use (typically 3 angles, phi, chi, omega).</li>
<li>The first column has a checkbox (X) if you are going to use this sample orientation in the experiment. Double-click to uncheck or recheck the box.</li>
<ul>
<li>When you do so, the coverage corresponding to this sample orientation is removed from the total.</li>
</ul>
<li>The <strong>Stopping Criterion</strong> column allows you to specify <i>how long</i> to do the measurement for that particular sample orientation. You get a drop-down list of a few options:</li>
<ul>
<dt>runtime</dt>
<dd>The time to acquire data, in seconds.</dd>
</ul>
</ul>


<h4>YYYY.1. Coverage Statistics</h4>

<li>On the bottom right, you can see the coverage statistics panel:
<br/><img src="screenshots/3d-panelStats.png"/>
</li>
<ul>
<li>The first bar indicates what percentage of reciprocal space volume was measured (at least once).</li>
<li>The second bar shows the redundant measurements - the proportion of q-space that was measured at least twice.</li>
</ul>
<li>Next is a coverage "slice" plot:
<br/><img src="screenshots/3d-panelStats.png"/>
</li>


</body>
</html>